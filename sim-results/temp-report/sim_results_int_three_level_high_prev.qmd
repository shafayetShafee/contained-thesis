---
title: "Simulation Result For Three-Level Intercept Model With High Prevalence"
author: Shafayet Khan Shafee
date: last-modified
date-format: "DD MMMM YYYY"
format: 
  pdf:
    classoption: titlepage
    fig-pos: 'H'
    keep-tex: true
    geometry:
      - top=20mm
      - bottom=5mm
    include-in-header:
      text: |
        \usepackage{typearea}
        \usepackage{caption}
        \usepackage{subcaption}
---


```{r}
#| echo: false
#| message: false
#| warning: false

library(dplyr)
library(kableExtra)

final_res_int_high_prev <- readRDS(
  here::here("sim-results/rds/sim_res_three_lvl_int_high_prev.rds")
  )

mean_prevalence <- round(mean(final_res_int_high_prev$prevalence), 2)*100
```


---
subtitle: "The mean prevalence for this simulation is `r mean_prevalence` %"
---

# Histograms for $log(\widehat{MOR})$

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_5_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m10n51}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_5_three_lvl_high_prev_mor2.png}  
    \caption{MOR\textsubscript{2}}
    \label{l20m10n52}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 10, Patients = 5}
\label{mor1}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_15_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m10n151}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_15_three_lvl_high_prev_mor2.png}  
    \caption{MOR\textsubscript{2}}
    \label{l20m10n152}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 10, Patients = 15}
\label{mor1}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_30_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m10n151}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_10_30_three_lvl_high_prev_mor2.png}  
    \caption{MOR\textsubscript{2}}
    \label{l20m10n152}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 10, Patients = 30}
\label{mor1}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_5_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m30n51}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_5_three_lvl_high_prev_mor2.png}  
    \caption{MOR\textsubscript{2}}
    \label{l20m30n52}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 30, Patients = 5}
\label{mor1}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_15_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m30n151}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_15_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l20m30n152}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 30, Patients = 15}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_30_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l20m30n301}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_20_30_30_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l20m30n302}
\end{subfigure}
\caption{Hospitals = 20, Doctors = 30, Patients = 30}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_5_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m10n51}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_5_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m10n52}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 10, Patients = 5}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_15_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m10n151}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_15_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m10n152}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 10, Patients = 15}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_30_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m10n301}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_10_30_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m10n302}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 10, Patients = 30}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_5_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m30n51}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_5_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m30n52}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 30, Patients = 5}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_15_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m30n151}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_15_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m30n152}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 30, Patients = 15}
\label{mor2}
\end{figure}

\vspace{10mm}

\begin{figure}
\centering
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_30_three_lvl_high_prev_mor1.png}  
    \caption{MOR\textsubscript{1}}
    \label{l40m30n301}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
    \centering
    \includegraphics[width=.95\linewidth]{../../plots/three-lvl-ran-int/high-prev/hist_40_30_30_three_lvl_high_prev_mor2.png}
    \caption{MOR\textsubscript{2}}
    \label{l40m30n302}
\end{subfigure}
\caption{Hospitals = 40, Doctors = 30, Patients = 30}
\label{mor2}
\end{figure}


\newpage
\newgeometry{right=10mm,left=15mm,top=20mm}

<!-- --------------------------------------------------------------------------- -->
<!-- --------------------------------------------------------------------------- -->
<!-- --------------------------------------------------------------------------- -->

# Simulation Result Table for MOR of Second Level

```{r}
#| echo: false
sim_output_table <- final_res_int_high_prev %>%
  mutate(
    ratio1 = se_mor1_hat / sim_se_mor1_hat,
    ratio2 = se_mor2_hat / sim_se_mor2_hat
    ) %>%
  select(ea_number, hh_number, hh_size, beta0_hat, beta1_hat, beta2_hat,
         sigma_u_sq_hat, sigma_v_sq_hat,
         mor1_hat, relative_bias_1, se_mor1_hat,
         sim_se_mor1_hat, ratio1, coverage_1,
         mor2_hat, relative_bias_2, se_mor2_hat,
         sim_se_mor2_hat, ratio2, coverage_2,
         convergence = converged)
```


```{r}
#| echo: false
mor1_table <- sim_output_table %>% 
  select(ea_number, hh_number, hh_size, beta0_hat, beta1_hat, beta2_hat,
         sigma_u_sq_hat, sigma_v_sq_hat,
         mor1_hat, relative_bias_1, se_mor1_hat,
         sim_se_mor1_hat, ratio1, coverage_1,
         convergence)

mor2_table <- sim_output_table %>% 
  select(ea_number, hh_number, hh_size, beta0_hat, beta1_hat, beta2_hat,
         sigma_u_sq_hat, sigma_v_sq_hat,
         mor2_hat, relative_bias_2, se_mor2_hat,
         sim_se_mor2_hat, ratio2, coverage_2,
         convergence)
```

\begingroup
<!-- \setlength{\LTleft}{0pt minus 5000pt} -->
<!-- \setlength{\LTright}{0pt minus 5000pt} -->
\fontsize{8pt}{16pt}\selectfont
<!-- \addtolength{\tabcolsep}{0.pt} -->


```{r}
#| echo: false
kableExtra::kbl(mor1_table, booktabs = TRUE, digits = 2, linesep = "",
                align = paste0(rep('c', ncol(mor1_table)),collapse = ""),
                col.names = c("L\\textsuperscript{1}", "M\\textsuperscript{2}",
                              "N\\textsuperscript{3}",
                            "$\\widehat{\\beta_0}$", "$\\widehat{\\beta_1}$",
                            "$\\widehat{\\beta_2}$",
                            "$\\widehat{\\sigma^2_{u_{jk}}}$",
                            "$\\widehat{\\sigma^2_{v_k}}$",
                            "$\\widehat{MOR_1}$", "Rel. Bias (\\%)",
                            "$\\widehat{SE}_{MOR}$",
                            "Sim. $\\widehat{SE}_{MOR}$",
                            "Ratio\\textsuperscript{4}",
                            "Coverage\\textsuperscript{5} (95\\%)",
                            "Model Conv\\textsuperscript{6}"), escape = FALSE) %>%
  column_spec(1:3, width = "0.6cm", latex_valign = "m") %>%
  column_spec(4:8, width = "0.7cm", latex_valign = "m") %>%
  column_spec(9:ncol(mor1_table), width = "1cm", latex_valign = "m") %>%
  footnote(
    general = " ",
    symbol = c(
      paste0("The mean prevalence for this simulation is ", mean_prevalence, "\\\\%"),
      "True $MOR_1$ is 3.85",
      "True $\\\\sigma^2_{u_{jk}}$ is 2",
      "True $\\\\sigma^2_{v_k}$ is 2.5",
      "True Values of $\\\\beta_0 = -1.85$, $\\\\beta_1 = 1.75$, $\\\\beta_2 = 0.67$"
    ),
    number = c(
      "Number of Hospital",
      "Number of Doctors",
      "Number of patients",
      "Ratio$\\\\;=\\\\;\\\\dfrac{\\\\widehat{SE}_{MOR}}{Simulation\\\\;\\\\widehat{SE}_{MOR}}$",
      "Confidence Interval Coverage Probability",
      "Model Convergence (Ratio of 1000 runs to the runs required to get 1000 converged cases)"
      ),
    escape = FALSE
  ) %>%
  row_spec(
    seq(
      n_distinct(mor1_table$hh_size), 
      nrow(mor1_table) - 1, 
      n_distinct(mor1_table$hh_size)), hline_after = TRUE
  )

```

\endgroup



# Simulation Result Table for MOR of Third Level

\begingroup
<!-- \setlength{\LTleft}{0pt minus 5000pt} -->
<!-- \setlength{\LTright}{0pt minus 5000pt} -->
\fontsize{8pt}{16pt}\selectfont
<!-- \addtolength{\tabcolsep}{0.pt} -->


```{r}
#| echo: false
kableExtra::kbl(mor2_table, booktabs = TRUE, digits = 2, linesep = "",
                align = paste0(rep('c', ncol(mor2_table)),collapse = ""),
                col.names = c("L\\textsuperscript{1}", "M\\textsuperscript{2}",
                              "N\\textsuperscript{3}",
                            "$\\widehat{\\beta_0}$", "$\\widehat{\\beta_1}$",
                            "$\\widehat{\\beta_2}$",
                            "$\\widehat{\\sigma^2_{u_{jk}}}$",
                            "$\\widehat{\\sigma^2_{v_k}}$",
                            "$\\widehat{MOR_2}$", "Rel. Bias (\\%)",
                            "$\\widehat{SE}_{MOR}$",
                            "Sim. $\\widehat{SE}_{MOR}$",
                            "Ratio\\textsuperscript{4}",
                            "Coverage\\textsuperscript{5} (95\\%)",
                            "Model Conv\\textsuperscript{6}"), escape = FALSE) %>%
  column_spec(1:3, width = "0.6cm", latex_valign = "m") %>%
  column_spec(4:8, width = "0.7cm", latex_valign = "m") %>%
  column_spec(9:ncol(mor2_table), width = "1cm", latex_valign = "m") %>%
  footnote(
    general = " ",
    symbol = c(
      paste0("The mean prevalence for this simulation is ", mean_prevalence, "\\\\%"),
      "True $MOR_2$ is 7.56",
      "True $\\\\sigma^2_{u_{jk}}$ is 2",
      "True $\\\\sigma^2_{v_k}$ is 2.5",
      "True Values of $\\\\beta_0 = -1.85$, $\\\\beta_1 = 1.75$, $\\\\beta_2 = 0.67$"
    ),
    number = c(
      "Number of Hospital",
      "Number of Doctors",
      "Number of patients",
      "Ratio$\\\\;=\\\\;\\\\dfrac{\\\\widehat{SE}_{MOR}}{Simulation\\\\;\\\\widehat{SE}_{MOR}}$",
      "Confidence Interval Coverage Probability",
      "Model Convergence (Ratio of 1000 runs to the runs required to get 1000 converged cases)"
      ),
    escape = FALSE
  ) %>%
  row_spec(
    seq(
      n_distinct(mor2_table$hh_size), 
      nrow(mor2_table) - 1, 
      n_distinct(mor2_table$hh_size)), hline_after = TRUE
  )

```


\endgroup

\newpage

\KOMAoptions{usegeometry,paper=landscape,pagesize}
\recalctypearea
\newgeometry{right=10mm,left=10mm,top=15mm,bottom=2mm}

# Simulation Result Table All Together

\begingroup
<!-- \setlength{\LTleft}{0pt minus 5000pt} -->
<!-- \setlength{\LTright}{0pt minus 5000pt} -->
\fontsize{8pt}{14pt}\selectfont
<!-- \addtolength{\tabcolsep}{0.pt} -->


```{r}
#| echo: false
kableExtra::kbl(sim_output_table, booktabs = TRUE, digits = 2, linesep = "",
                align = paste0(rep('c', ncol(sim_output_table)),collapse = ""),
                col.names = c("L\\textsuperscript{1}", "M\\textsuperscript{2}",
                              "N\\textsuperscript{3}",
                            "$\\widehat{\\beta_0}$", "$\\widehat{\\beta_1}$",
                            "$\\widehat{\\beta_2}$",
                            "$\\widehat{\\sigma^2_{u_{jk}}}$",
                            "$\\widehat{\\sigma^2_{v_k}}$",
                            "$\\widehat{MOR}$", "Rel. Bias (\\%)",
                            "$\\widehat{SE}_{MOR}$",
                            "Sim. $\\widehat{SE}_{MOR}$",
                            "Ratio\\textsuperscript{4}",
                            "Coverage\\textsuperscript{5} (95\\%)",
                            "$\\widehat{MOR}$", "Rel. Bias (\\%)",
                            "$\\widehat{SE}_{MOR}$",
                            "Sim. $\\widehat{SE}_{MOR}$",
                            "Ratio\\textsuperscript{4}",
                            "Coverage\\textsuperscript{5} (95\\%)",
                            "Model Conv\\textsuperscript{6}"), escape = FALSE) %>%
  column_spec(1:3, width = "0.4cm", latex_valign = "m") %>%
  column_spec(4:8, width = "0.7cm", latex_valign = "m") %>%
  column_spec(9:ncol(sim_output_table), width = "0.95cm", latex_valign = "m") %>%
  footnote(
    general = " ",
    symbol = c(
      paste0("The mean prevalence for this simulation is ", mean_prevalence, "\\\\%"),
      "True $MOR_1$ is 3.85",
      "True $MOR_2$ is 7.56",
      "True $\\\\sigma^2_{u_{jk}}$ is 2",
      "True $\\\\sigma^2_{v_k}$ is 2.5",
      "True Values of $\\\\beta_0 = -1.85$, $\\\\beta_1 = 1.75$, $\\\\beta_2 = 0.67$"
    ),
    number = c(
      "Number of Hospital",
      "Number of Doctors",
      "Number of patients",
      "Ratio$\\\\;=\\\\;\\\\dfrac{\\\\widehat{SE}_{MOR}}{Simulation\\\\;\\\\widehat{SE}_{MOR}}$", 
      "Confidence Interval Coverage Probability",
      "Model Convergence (Ratio of 1000 runs to the runs required to get 1000 converged cases)"
      ),
    escape = FALSE
  ) %>%
  add_header_above(
    header = c(" " = 8, "$MOR_1$" = 6, "$MOR_2$" = 6, " " = 1),
    escape = FALSE
  ) %>% 
  row_spec(
    seq(
      n_distinct(sim_output_table$hh_size), 
      nrow(sim_output_table) - 1, 
      n_distinct(sim_output_table$hh_size)), hline_after = TRUE
  )

```


\endgroup
